async function w(){try{const t=fetch("/api/products"),e=fetch("/api/services"),[s,n]=await Promise.all([t,e]);if(s.ok&&n.ok){const[o,c]=await Promise.all([s.json(),n.json()]);return{products:o.products||o||[],services:c.services||c||[]}}return console.error("API endpoints returned non-ok status"),{products:[],services:[]}}catch(t){return console.error("Failed to load product/service data:",t),{products:[],services:[]}}}function f(t){const e=document.createElement("div");e.className="slider-card",e.dataset.id=String(t.id);const s=document.createElement("img");s.src=t.image,s.alt=t.name;const n=document.createElement("div");n.className="product-desc";const o=document.createElement("h2");o.textContent=t.name;const c=document.createElement("p");c.textContent=t.description;const r=document.createElement("h2");r.className="product-price",r.textContent=`$${t.price}`;const i=document.createElement("a");i.href="/orders",i.className="card-order-button",i.textContent="Order Now";const a=document.createElement("button");a.className="card-order-button card-wishlist-button",a.type="button",a.dataset.id=String(t.id),a.textContent=u(t.id)?"Remove":"Wishlist",a.addEventListener("click",async p=>{p.preventDefault(),p.stopPropagation(),console.log("Wishlist button clicked for item:",t.id),await g(t.id)}),n.appendChild(o),n.appendChild(c);const d=document.createElement("div");return d.className="card-controls",d.appendChild(r),a.classList.add("card-wishlist-button"),d.appendChild(a),n.appendChild(d),e.appendChild(s),e.appendChild(n),e}function E(){const t=document.createElement("div");return t.className="first-service",t}async function C(){await l();const t=await w(),e=document.querySelector("#product .slider-track"),s=document.querySelector("#service .slider-track");!e&&!s||(e&&(e.innerHTML="",t.products.forEach(n=>{e.appendChild(f(n))})),s&&(s.innerHTML="",t.services.forEach(n=>{n.image&&n.image.startsWith("resources/images/")&&(n.image=n.image.replace(/^resources\/images\//,"/images/")),s.appendChild(f(n))}),s.appendChild(E())),document.dispatchEvent(new CustomEvent("products:rendered")))}document.addEventListener("DOMContentLoaded",()=>{C()});document.addEventListener("wishlist:changed",()=>{try{v()}catch{}});let m=null;async function l(){try{const t=await fetch("/api/wishlist");if(!t.ok)throw new Error("Failed to fetch wishlist");return m=(await t.json()).wishlist||[],m}catch(t){return console.error("Failed to load wishlist:",t),m=[],[]}}function h(){return m||[]}function u(t){return h().some(s=>String(s.itemId)===String(t))}async function y(t,e){try{console.log("POST /api/wishlist with:",{itemId:String(t),itemType:e});const s=await fetch("/api/wishlist",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({itemId:String(t),itemType:e})}),n=await s.json();if(console.log("API response:",n),!s.ok)throw new Error("Failed to add to wishlist");return await l(),!0}catch(s){return console.error("Failed to add to wishlist:",s),!1}}async function S(t,e){try{console.log("DELETE /api/wishlist/item with:",{itemId:t,itemType:e});const s=await fetch(`/api/wishlist/item/${t}/${e}`,{method:"DELETE"}),n=await s.json();if(console.log("API response:",n),!s.ok)throw new Error("Failed to remove from wishlist");return await l(),!0}catch(s){return console.error("Failed to remove from wishlist:",s),!1}}async function g(t){const e=String(t),s=u(e);console.log("toggleWishlist called:",{itemId:e,inWishlist:s});const n=await w();let o="product";(n.services||[]).find(i=>String(i.id)===e)&&(o="service"),console.log("Item type determined:",o);let r=!1;if(s?(console.log("Removing from wishlist..."),r=await S(e,o)):(console.log("Adding to wishlist..."),r=await y(e,o)),console.log("Operation success:",r),r){document.querySelectorAll(".card-wishlist-button").forEach(a=>{if(a.dataset.id==e){const d=u(e);a.textContent=d?"Remove":"Wishlist",a.style&&(a.style.background=d?"#f44336":"#4CAF50")}});const i=h().length;document.dispatchEvent(new CustomEvent("wishlist:changed",{detail:{count:i}}))}}function v(){const t=document.querySelector(".wishlist-badge");if(!t)return;const e=h().length||0;t.textContent=String(e),e===0?t.style.opacity="0.9":t.style.opacity="1"}window.updateWishlistBadge=v;window.getWishlist=h;window.isWishlisted=u;window.toggleWishlist=g;window.loadWishlist=l;document.addEventListener("DOMContentLoaded",async()=>{await l(),v()});function W(t){const e=document.createElement("div");e.className="product-card",e.dataset.id=String(t.id);const s=document.createElement("img");s.src=t.image,s.alt=t.name,s.className="product-image";const n=document.createElement("div");n.className="product-info";const o=document.createElement("h4");o.textContent=t.name;const c=document.createElement("div");c.className="product-price",c.textContent=`$${t.price}`;const r=document.createElement("p");r.className="product-description",r.textContent=t.description;const i=document.createElement("button");i.className="btn-delete card-wishlist-button",i.type="button",i.dataset.id=String(t.id);const a=()=>{const d=u(t.id);i.textContent=d?"Remove from Wishlist":"Add to Wishlist",i.className=d?"btn-delete card-wishlist-button":"card-wishlist-button"};return a(),i.addEventListener("click",async d=>{d.preventDefault(),d.stopPropagation(),i.disabled=!0,i.textContent="Processing...";try{await g(t.id),a()}catch(p){console.error("Failed to toggle wishlist:",p),alert("Failed to update wishlist")}finally{i.disabled=!1}}),n.appendChild(o),n.appendChild(c),n.appendChild(r),n.appendChild(i),e.appendChild(s),e.appendChild(n),e}window.renderSearchResults=async function(t,e){if(!t)return;t.innerHTML="<p>Loading...</p>",await l();const s=(e||"").trim().toLowerCase();if(!s){t.innerHTML="<p>Please enter a search query.</p>";return}const n=await w(),o=[];(n.products||[]).forEach(i=>o.push(i)),(n.services||[]).forEach(i=>o.push(i));const c=o.filter(i=>(i.name||"").toLowerCase().includes(s));if(c.length===0){t.innerHTML="<p>No results found.</p>";return}t.innerHTML="";const r=document.createElement("div");r.className="product-grid",c.forEach(i=>{const a=W(i);r.appendChild(a)}),t.appendChild(r)};async function L(t){if(!t)return;t.innerHTML="<p>Loading wishlist...</p>",await l();const e=h();if(e.length===0){t.innerHTML="<p>Your wishlist is empty.</p>";return}const s=await w(),n=[];(s.products||[]).forEach(o=>n.push(o)),(s.services||[]).forEach(o=>n.push(o)),t.innerHTML="",e.forEach(o=>{const c=n.find(r=>String(r.id)===String(o.itemId));if(c){const r=f(c);t.appendChild(r)}})}window.renderWishlistPage=L;
